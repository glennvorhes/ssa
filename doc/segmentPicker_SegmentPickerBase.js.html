<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>JSDoc: Source: segmentPicker/SegmentPicker.js</title>

    <script src="scripts/prettify/prettify.js"> </script>
    <script src="scripts/prettify/lang-css.js"> </script>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <link type="text/css" rel="stylesheet" href="styles/prettify-tomorrow.css">
    <link type="text/css" rel="stylesheet" href="styles/jsdoc-default.css">
</head>

<body>

<div id="main">

    <h1 class="page-title">Source: segmentPicker/SegmentPicker.js</h1>

    



    
    <section>
        <article>
            <pre class="prettyprint source linenums"><code>/**
 * Created by gavorhes on 5/13/2016.
 */

import provide from 'webmapsjs/src/util/provide';
import quickMapMulti from 'webmapsjs/src/olHelpers/quickMapMulti';
import SortedFeatures from 'webmapsjs/src/olHelpers/SortedFeatures';
import LayerBaseVectorGeoJson from 'webmapsjs/src/layers/LayerBaseVectorGeoJson';
import LayerEsriMapServer from 'webmapsjs/src/layers/LayerEsriMapServer';
import SelectBoxBase from '../selectBox/SelectBoxBase';
import ol from 'webmapsjs/src/ol/ol';
import Ajx from '../AjaxGetters';
import $ from 'webmapsjs/src/jquery/jquery';
import * as layerStyles from '../layerStyles';
const nm = provide('ssa.select');


class SegmentPicker extends SelectBoxBase {

    /**
     *
     * @param {jQuery} parent - parent container
     * @param {string} labelContent - label associated with the select box
     */
    constructor(parent, labelContent) {
        let mapId = undefined;

        function contentGen(guid) {
            mapId = guid + '-map';
            let outString = '';
            outString += `&lt;div style="position: relative;" class="select-picker-map-container">`;
            outString += `  &lt;select id="${guid}">&lt;/select>`;
            outString += `  &lt;div class="seg-popup-container">`;
            outString += '    &lt;div>';
            outString += `      &lt;span class="selected-segment-info">&lt;/span>`;
            outString += `      &lt;span title="Close" class="container-head-close">X&lt;/span>`;
            outString += '    &lt;/div>';
            outString += `    &lt;div id="${mapId}" class="rp-picker-map">&lt;/div>`;
            outString += '  &lt;/div>';
            outString += `&lt;/div>`;

            return outString;
        }

        super(parent, labelContent, contentGen);
        /**
         *
         * @type {number|undefined}
         * @private
         */
        this._selectedPdpId = undefined;

        this._visible = false;
        this._mapDivId = mapId;
        this._$mapContainer = this._$container.find('.seg-popup-container');

        this._$container.find('.seg-popup-container').click((evt) => {
            evt.stopPropagation();
        });

        this._$container.find('.container-head-close').click(() => {
                this.visible = false;
            }
        );

        this._$segmentInfo = this._$container.find('.selected-segment-info');

        this._$container.find('.select-picker-map-container').click(() => {
            this.visible = true;
        });

        this.addChangeListener((v) => {
            this.selectedPdpId = parseInt(v);
        });

        this.box.keyup(() => {
            if (this.selectedPdpId != parseInt(this.selectedValue)) {
                this.box.trigger('change');
            }
        });

        /**
         *
         * @type {SortedFeatures|undefined}
         * @private
         */
        this._sortedFeatures = undefined;


        /**
         *
         * @type {SegmentPicker|undefined}
         * @public
         */
        this.otherPicker = undefined;

        /**
         *
         * @type {Map}
         * @private
         */
        this._pickerMap = undefined;

        /**
         * @type MapMoveCls
         * @private
         */
        this._pickerMapMove = undefined;

        /**
         * @type MapPopupCls
         * @private
         */
        this._pickerMapPopup = undefined;


        /**
         *
         * @type {LayerBaseVectorGeoJson}
         * @protected
         */
        this._segmentLayer = new LayerBaseVectorGeoJson('',
            {
                minZoom: 7,
                mapMoveObj: this._pickerMapMove,
                name: 'MM Segments',
                transform: {dataProjection: 'EPSG:3857', featureProjection: 'EPSG:3857'},
                style: layerStyles.segmentLayer
            }
        );

        this._segNodeLayer = new LayerBaseVectorGeoJson('', {
            style: layerStyles.segNodeStyle,
            minZoom: 11
        });

        this._segmentSelectionLayer = new ol.layer.Vector({
            source: new ol.source.Vector(),
            style: this.selectionStyle,
            zIndex: 50
        });

        this.otherSelectedSegmentLayer = new ol.layer.Vector({
            source: new ol.source.Vector(),
            style: this.selectionStyleOther,
            zIndex: 49
        });

        this._enabled = false;
    }

    /**
     *
     * @private
     */
    _mapInit() {
        let multiMap = quickMapMulti({
            divId: this._mapDivId,
            minZoom: 6,
            zoom: 6,
            baseSwitcher: false
        });
        $('.ol-zoom-out').html('&amp;#8211;');

        this._pickerMap = multiMap.map;
        this._pickerMapMove = multiMap.mapMove;
        this._pickerMapPopup = multiMap.mapPopup;

        let metamanagerSegments = new LayerEsriMapServer(
            'http://transportal.cee.wisc.edu/applications/arcgis2/rest/services/MetaManager/MM_All_Segments/MapServer',
            {
                minZoom: 7,
                visible: true,
                name: 'Metamanager Segments',
                opacity: 0.6
            });

        // add the layers to the map
        this._pickerMap.addLayer(metamanagerSegments.olLayer);
        this._pickerMap.addLayer(this._segmentLayer.olLayer);
        this._pickerMap.addLayer(this._segmentSelectionLayer);
        this._pickerMap.addLayer(this.otherSelectedSegmentLayer);
        this._pickerMap.addLayer(this._segNodeLayer.olLayer);

        this._setExtent();

        // configure the popup response function
        this._pickerMapPopup.addVectorPopup(this._segmentLayer, (props) => {
            let returnHtml = '&lt;table class="mm-popup-table">';
            returnHtml += `&lt;tr>&lt;td>PdpId&lt;/td>&lt;td>${props['pdpId']}&lt;/td>;`;
            returnHtml += `&lt;td rowspan="5">`;
            returnHtml += `&lt;input type="button" id='${props['pdpId']}' class="select-seg-btn" value="Select"/>`;
            returnHtml += `&lt;/td>&lt;/tr>`;
            returnHtml += `&lt;tr>&lt;td>Hwy&lt;/td>&lt;td>${props['hwyDir']}&lt;/td>&lt;/tr>`;
            returnHtml += `&lt;tr>&lt;td>DivUnd&lt;/td>&lt;td>${props['divUnd']}&lt;/td>&lt;/tr>`;
            returnHtml += `&lt;tr>&lt;td>From&lt;/td>&lt;td>${props['pdpFrom']}&lt;/td>&lt;/tr>`;
            returnHtml += `&lt;tr>&lt;td>To&lt;/td>&lt;td>${props['pdpTo']}&lt;/td>&lt;/tr>`;
            returnHtml += '&lt;/table>';

            return returnHtml;
        });

        // add the popup change function to find the select button
        this._pickerMapPopup.addPopupChangedFunction(() => {
            let selectButton = $('.select-seg-btn');
            if (selectButton.length > 0) {
                let _this = this;
                selectButton.click(function () {
                    _this.selectedPdpId = this['id'];
                });
            }
        });
    }

    /**
     * @abstract
     * @param {Array&lt;object>} arr - array of returned objects, implementation defined in derived classes
     */
    _processAjaxResult(arr) {
    }

    /**
     *
     * @param {string|number} county - county id as string or number
     * @param {string|number|null} rteId - routeId
     * @param {number|undefined} [pdpId=undefined] - the pdp id to be set on load
     */
    setCountyAndRoute(county, rteId, pdpId) {
        pdpId = typeof pdpId == 'number' ? pdpId : undefined;

        this.selectedPdpId = undefined;
        this.box.html('');
        this.box.addClass('refresh').removeClass('refresh');

        if (this._pickerMapPopup) {
            this._pickerMapPopup.closePopup();
        }

        if (typeof county == 'string') {
            county = parseInt(county);
        }

        if (rteId == null){
            this.enabled = false;

            return;
        }

        if (typeof rteId == 'string') {
            rteId = parseInt(rteId);
        }

        Ajx.getSegments(county, rteId, (d) => {
                this._segmentLayer.clear();
                this._segNodeLayer.clear();
                this._processAjaxResult(d['features']);
                if (d['features'].length > 0) {
                    this.enabled = true;
                    this._segmentLayer.addFeatures(d);
                    let feats = this._segmentLayer.source.getFeatures();
                    this._sortedFeatures = new SortedFeatures(feats, 'pdpId');
                    this._setExtent();

                    if (typeof pdpId == 'number') {
                        // this.box.val(pdpId.toFixed());
                        this.selectedPdpId = pdpId;
                    } else {
                        this.box.trigger('change');
                    }

                    for (let i =0; i &lt; feats.length; i++){
                        let coords = feats[i].getGeometry()['getCoordinates']();
                        if (coords.length > 0){
                        this._segNodeLayer.source.addFeature(new ol.Feature(new ol.geom.Point(coords[0])));
                        this._segNodeLayer.source.addFeature(new ol.Feature(new ol.geom.Point(coords[coords.length - 1])));
                        }
                    }
                } else {
                    this.enabled = false;
                }
            }
        );
    }

    _setExtent() {
        if (this._pickerMap &amp;&amp; this._segmentLayer.source.getFeatures().length > 0) {
            this._pickerMap.getView().fit(this._segmentLayer.source.getExtent(), this._pickerMap.getSize());

        } else {
            // console.log('no features');
        }
    }

    /**
     * @returns {boolean} if enabled
     */
    get enabled() {
        return this._enabled;
    }

    /**
     *
     * @param {boolean} isEnabled - is enabled
     * @private
     */
    set enabled(isEnabled) {
        this._enabled = isEnabled;
        this.box.prop('disabled', !isEnabled);
    }


    /**
     * get the picker visibility
     * @returns {boolean} is visible
     */
    get visible() {
        return this._visible;
    }

    /**
     * set the picker visibility
     * @param {boolean} vis is visible
     */
    set visible(vis) {
        if (this.visible === vis) {
            return;
        }

        if (vis &amp;&amp; this.enabled) {
            this._$mapContainer.show();
            if (!this._pickerMap) {
                this._mapInit();
            }
            if (this.otherPicker) {
                this.otherPicker.visible = false;
            }
        } else {
            this._$mapContainer.hide();
            if (this._pickerMapPopup) {
                this._pickerMapPopup.closePopup();
            }
        }
        this._visible = vis;

    }

    /**
     *
     * @returns {number|undefined} selected id
     */
    get selectedPdpId() {
        return this._selectedPdpId;
    }

    /**
     *
     * @param {number|undefined} newId - new selected id
     */
    set selectedPdpId(newId) {
        if (this._pickerMapPopup) {
            this._pickerMapPopup.closePopup();
        }

        if (typeof newId == 'string') {
            newId = parseInt(newId);
        }

        if (newId == this._selectedPdpId) {
            return;
        }

        this._selectedPdpId = newId;

        this._segmentSelectionLayer.getSource().clear();
        this.otherPicker.otherSelectedSegmentLayer.getSource().clear();

        if (this._selectedPdpId == undefined) {
            this._$segmentInfo.html('');

        } else {
            this.box.val(this.selectedPdpId);
            let selectedFeature = this._sortedFeatures.getFeature(this.selectedPdpId);

            this._segmentSelectionLayer.getSource().addFeature(selectedFeature);
            this.otherPicker.otherSelectedSegmentLayer.getSource().addFeature(selectedFeature);

            let props = selectedFeature.getProperties();

            this._$segmentInfo.html(`Seg ID: ${props['pdpId']}, Ref. Point ${props['pdpFrom']}-${props['pdpTo']}`);
        }
    }

    clear() {
        this.box.html('');
        this.selectedPdpId = undefined;
        this.visible = false;
    }

    /**
     * @abstract
     * @returns {ol.style.Style} selection style
     */
    get selectionStyle() {
        return new ol.style.Style({
            stroke: new ol.style.Stroke({color: 'orange', width: 7})
        });
    }


    /**
     * @abstract
     * @returns {ol.style.Style} other selection style
     */
    get selectionStyleOther() {
        return new ol.style.Style({
            stroke: new ol.style.Stroke({color: 'orange', width: 7})
        });
    }
}

nm.SegmentPicker = SegmentPicker;
export default SegmentPicker;
</code></pre>
        </article>
    </section>




</div>

<nav>
    <h2><a href="index.html">Home</a></h2><h3>Classes</h3><ul><li><a href="AjaxGetters.html">AjaxGetters</a></li><li><a href="Corridor.html">Corridor</a></li><li><a href="CorridorCollection.html">CorridorCollection</a></li><li><a href="CorridorConfig.html">CorridorConfig</a></li><li><a href="PickerCollection.html">PickerCollection</a></li><li><a href="SegmentPickerBase.html">SegmentPicker</a></li><li><a href="SegmentPickerFrom.html">SegmentPickerFrom</a></li><li><a href="SegmentPickerTo.html">SegmentPickerTo</a></li><li><a href="SelectBoxBase.html">SelectBoxBase</a></li><li><a href="SelectCounty.html">SelectCounty</a></li><li><a href="SelectEndCounty.html">SelectEndCounty</a></li><li><a href="SelectHighway.html">SelectHighway</a></li><li><a href="SelectStartCounty.html">SelectStartCounty</a></li><li><a href="SsaMapCreate.html">SsaMapCreate</a></li><li><a href="SsaMapView.html">SsaMapView</a></li></ul><h3>Global</h3><ul><li><a href="global.html#_ajaxHelper">_ajaxHelper</a></li><li><a href="global.html#_ajaxInner">_ajaxInner</a></li><li><a href="global.html#_dteStrip">_dteStrip</a></li><li><a href="global.html#crashPointStyle">crashPointStyle</a></li><li><a href="global.html#exampleCrashData">exampleCrashData</a></li><li><a href="global.html#exampleData">exampleData</a></li><li><a href="global.html#getCountyById">getCountyById</a></li><li><a href="global.html#layerConfigHelper">layerConfigHelper</a></li><li><a href="global.html#randomColor">randomColor</a></li><li><a href="global.html#returnedColors">returnedColors</a></li><li><a href="global.html#tableContent">tableContent</a></li></ul>
</nav>

<br class="clear">

<footer>
    Documentation generated by <a href="https://github.com/jsdoc3/jsdoc">JSDoc 3.4.0</a> on Fri Jul 22 2016 14:00:42 GMT-0500 (Central Daylight Time)
</footer>

<script> prettyPrint(); </script>
<script src="scripts/linenumber.js"> </script>
</body>
</html>
